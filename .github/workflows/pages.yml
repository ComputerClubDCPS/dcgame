# File: .github/workflows/deploy.yml
name: Deploy GitHub Pages

# Controls when the workflow will run
on:
  # Triggers the workflow on push events but only for the main branch
  push:
    branches: [ main ]

# Sets up the jobs that will run
jobs:
  transform_and_deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch depth 0 is crucial if you plan to push back to the branch you checked out
          fetch-depth: 0

      # 2. Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 5. Run the Conversion Script
      - name: Run Conversion Script (MD -> HTML in root)
        run: node ./scripts/remark.js

      # 6. Check for changes (Package + Generated HTML files)
      - name: Check for modified files
        id: changed
        run: |
          # Check if dependency files OR any generated HTML files in the root were modified
          if git diff --exit-code package.json package-lock.json *.html; then
            echo "No dependency or HTML file changes detected."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Files have changed (package.json, lock, or generated HTML)."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # 7. Commit and Push CHANGES ONLY to the gh-pages branch
      - name: Commit and Push Changes to gh-pages
        if: steps.changed.outputs.changed == 'true'
        run: |
          echo "Committing generated files to gh-pages branch..."

          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

          # Add all relevant files: dependency manifests AND the newly generated HTML files
          git add package.json package-lock.json *.html

          COMMIT_MSG="chore: Install ${{ github.event.inputs.packageName }} & Update HTML via Remark"
          git commit -m "$COMMIT_MSG"

          # Push specifically to the gh-pages branch
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:gh-pages

  build_and_deploy:

    needs: [transform_and_deploy]
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Node.js (if you are using Node-based tools like npm or Yarn for building)
      #    If you are using Jekyll or Hugo, you might replace this with setup-ruby or setup-go
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use the current LTS version

      # 3. Install dependencies (Example for a Node project like React/Vue/Svelte)
      - name: Install dependencies
        run: npm install
        # If your project uses yarn: run: yarn install

      # 4. Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          # The Personal Access Token used to deploy (automatically provided by GitHub)
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # The directory containing the built static files to be published
          publish_dir: ./  # <-- IMPORTANT: Change 'docs' if your build output is elsewhere (e.g., 'public' for Hugo)

          # Set the branch where the site files will be pushed (GitHub Pages default)
          publish_branch: gh-pages

          # Add a CNAME file if you use a custom domain
          # cname: yourdomain.com
