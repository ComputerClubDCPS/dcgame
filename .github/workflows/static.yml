# Simple workflow for deploying static content to GitHub Pages
name: Deploy static content to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  md-to-html:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
            # 5. Run the Conversion Script (EMBEDDED SCRIPT)
            # 5. Run the Conversion Script (EMBEDDED SCRIPT - Correctly Quoted)
      - name: Run Conversion Script (MD -> HTML in root)
        run: |
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');
          const remark = require('remark');
          const html = require('remark-html');

          // We must define __dirname relative to the execution context (the repo root) 
          // OR ensure the path logic works from the context where the file is being run.
          // Since the script expects paths relative to its own location (scripts/), 
          // and we are now running it from the repo root, we might need to adjust the paths slightly.

          // Since we are running 'node' from the repo root, the script logic should be adapted:
          const SCRIPT_DIR = path.join(process.cwd(), 'scripts'); // Get path to scripts dir dynamically
          
          // Adjust MD_SOURCE_DIR to be relative to the repo root (where we are executing node)
          const MD_SOURCE_DIR = path.join(process.cwd(), 'data', 'md'); 
          const HTML_OUTPUT_DIR = process.cwd(); // Output to repository root (where we are running node)


          async function processMarkdown() {
              const files = fs.readdirSync(MD_SOURCE_DIR).filter(file => file.endsWith('.md'));

              for (const file of files) {
                  const mdFilePath = path.join(MD_SOURCE_DIR, file);
                  // The regex must be escaped properly for JS syntax
                  const htmlFileName = file.replace(/\.md$/, '.html'); 
                  const htmlFilePath = path.join(HTML_OUTPUT_DIR, htmlFileName);

                  console.log(`Processing ${file} -> ${htmlFileName}`);

                  const fileContent = fs.readFileSync(mdFilePath, 'utf8');

                  const result = await remark()
                      .use(html)
                      .process(fileContent);

                  fs.writeFileSync(htmlFilePath, String(result));
              }
              console.log('Markdown processing complete.');
          }

          processMarkdown().catch(err => {
              console.error('Error during Markdown processing:', err);
              process.exit(1);
          });
          EOF

    
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: md-to-html
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload entire repository
          path: '.'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
